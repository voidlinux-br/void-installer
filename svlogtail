#!/bin/sh

LOGROOT="/var/log/socklog"

usage () {
	cat <<-EOF
	Usage: svlogtail [LOG...]

	Examples:
	  svlogtail                # show all logs (historic + live)
	  svlogtail kernel         # by name
	  svlogtail auth
	  svlogtail daemon
	  svlogtail messages
	EOF
}

# Resolve argumento como caminho OU nome
resolve_log() {
	case "$1" in
		/*)
			[ -d "$1" ] && printf "%s\n" "$1" && return 0
			return 1
			;;
		*)
			[ -d "$LOGROOT/$1" ] && printf "%s\n" "$LOGROOT/$1" && return 0
			return 1
			;;
	esac
}

# -------- COLORIZADOR PROFISSIONAL --------
colorize() {
	awk '
		# Timestamp
		/^[0-9]{4}-[0-9]{2}-[0-9]{2}/ {
			printf "\033[90m%s\033[0m ", $1 " " $2
			sub(/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} /, "", $0)
		}

		# Kernel messages
		/kernel|kern/ && !/error|fail/ {
			print "\033[35m" $0 "\033[0m"
			next
		}

		# Auth / SSH
		/auth|sshd|pam/ {
			print "\033[31m" $0 "\033[0m"
			next
		}

		# Errors
		/ERROR|error|failed|FAIL|panic/ {
			print "\033[1;31m" $0 "\033[0m"
			next
		}

		# Warnings
		/WARN|Warn|warning/ {
			print "\033[33m" $0 "\033[0m"
			next
		}

		# Daemon/services
		/daemon/ {
			print "\033[32m" $0 "\033[0m"
			next
		}

		# Generic info
		/info|INFO/ {
			print "\033[36m" $0 "\033[0m"
			next
		}

		# Default
		{ print "\033[37m" $0 "\033[0m" }
	'
}

# -------------- MAIN --------------

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
	usage
	exit 0
fi

if [ $# -eq 0 ]; then
	logdirs=$(printf "%s\n" "$LOGROOT"/*/)
else
	logdirs=""
	for item in "$@"; do
		d="$(resolve_log "$item")" || {
			echo "svlogtail: no logs for '$item'" >&2
			exit 1
		}
		logdirs="$logdirs $d"
	done
fi

logdirs=$(echo "$logdirs" | tr ' ' '\n' | awk 'NF' | sort -u)

old=""
cur=""

for d in $logdirs; do
	old="$old $d"/*.[us]
	cur="$cur $d"/current
done

# HistÃ³rico (colorido)
cat $old $cur 2>/dev/null | sort | colorize

# Realtime follow (colorido)
tail -Fq -n0 $cur | colorize
